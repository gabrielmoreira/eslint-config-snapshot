name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  actions: write
  checks: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        node-version: [20.x, 22.x, latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm nx run-many -t lint

      - name: Typecheck
        run: pnpm nx run-many -t typecheck

      - name: Build
        run: pnpm nx run-many -t build

      - name: Test
        run: pnpm nx run-many -t test

      - name: CLI smoke
        run: node packages/cli/dist/index.js --help

  reports:
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ always() && needs.validate.result == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build (required for CLI integration tests)
        run: pnpm nx run-many -t build

      - name: Test API with coverage + JUnit
        run: pnpm vitest run --coverage.enabled --coverage.reporter=text-summary --coverage.reporter=json-summary --coverage.reporter=cobertura --coverage.reporter=html --reporter=default --reporter=junit --outputFile.junit=./test-results/junit.xml
        working-directory: packages/api

      - name: Test CLI with coverage + JUnit
        run: pnpm vitest run --coverage.enabled --coverage.reporter=text-summary --coverage.reporter=json-summary --coverage.reporter=cobertura --coverage.reporter=html --reporter=default --reporter=junit --outputFile.junit=./test-results/junit.xml
        working-directory: packages/cli

      - name: Publish unit test report
        if: always() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
        continue-on-error: true
        uses: dorny/test-reporter@v1
        with:
          name: Vitest Results
          path: packages/**/test-results/junit.xml
          reporter: java-junit
          fail-on-error: false

      - name: Publish coverage summary
        if: always()
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: packages/api/coverage/cobertura-coverage.xml,packages/cli/coverage/cobertura-coverage.xml
          badge: true
          fail_below_min: false
          format: markdown
          output: both

      - name: Publish coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v5
        with:
          files: packages/api/coverage/cobertura-coverage.xml,packages/cli/coverage/cobertura-coverage.xml
          flags: api,cli
          fail_ci_if_error: false
          verbose: true

      - name: Coverage quick summary
        if: always()
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('node:fs')
          const path = require('node:path')

          function readSummary(filePath) {
            const raw = fs.readFileSync(filePath, 'utf8')
            return JSON.parse(raw).total
          }

          function fmt(value) {
            return `${Number(value).toFixed(2)}%`
          }

          const api = readSummary(path.join(process.cwd(), 'packages/api/coverage/coverage-summary.json'))
          const cli = readSummary(path.join(process.cwd(), 'packages/cli/coverage/coverage-summary.json'))
          const lines = [
            '### Coverage Overview',
            '',
            '| Package | Lines | Statements | Functions | Branches |',
            '|---|---:|---:|---:|---:|',
            `| api | ${fmt(api.lines.pct)} | ${fmt(api.statements.pct)} | ${fmt(api.functions.pct)} | ${fmt(api.branches.pct)} |`,
            `| cli | ${fmt(cli.lines.pct)} | ${fmt(cli.statements.pct)} | ${fmt(cli.functions.pct)} | ${fmt(cli.branches.pct)} |`
          ]
          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `${lines.join('\n')}\n`)
          NODE

      - name: Upload test and coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-and-coverage-reports
          path: |
            packages/api/test-results/junit.xml
            packages/cli/test-results/junit.xml
            packages/api/coverage
            packages/cli/coverage

  publish-dispatch:
    runs-on: ubuntu-latest
    needs: [validate, reports]
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.validate.result == 'success' && needs.reports.result == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          registry-url: https://registry.npmjs.org

      - name: Detect npm drift
        id: drift
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('node:fs')
          const path = require('node:path')
          const { execFileSync } = require('node:child_process')

          function npmPublishedVersion(packageName) {
            try {
              return execFileSync('npm', ['view', packageName, 'version', '--silent'], {
                encoding: 'utf8',
                stdio: ['ignore', 'pipe', 'pipe']
              }).trim()
            } catch {
              return ''
            }
          }

          const packagesDir = path.join(process.cwd(), 'packages')
          const packageDirectories = fs
            .readdirSync(packagesDir, { withFileTypes: true })
            .filter((entry) => entry.isDirectory())
            .map((entry) => path.join(packagesDir, entry.name))

          const publishablePackages = packageDirectories
            .map((directory) => path.join(directory, 'package.json'))
            .filter((manifestPath) => fs.existsSync(manifestPath))
            .map((manifestPath) => JSON.parse(fs.readFileSync(manifestPath, 'utf8')))
            .filter((manifest) => manifest.private !== true && typeof manifest.name === 'string' && typeof manifest.version === 'string')

          const driftRows = []
          for (const manifest of publishablePackages) {
            const publishedVersion = npmPublishedVersion(manifest.name)
            const localVersion = manifest.version
            const drifted = publishedVersion.length === 0 || publishedVersion !== localVersion
            driftRows.push({
              name: manifest.name,
              localVersion,
              publishedVersion: publishedVersion || '<not published>',
              drifted
            })
          }

          const shouldPublish = driftRows.some((row) => row.drifted)
          const versionSet = new Set(driftRows.map((row) => row.localVersion))
          const inferredLabel = versionSet.size === 1 ? `v${driftRows[0]?.localVersion ?? 'unknown'}` : `mixed-${new Date().toISOString().slice(0, 10)}`

          console.log('npm drift scan:')
          for (const row of driftRows) {
            console.log(`- ${row.name}: local=${row.localVersion}, npm=${row.publishedVersion}, drift=${row.drifted ? 'yes' : 'no'}`)
          }
          console.log(`publish needed: ${shouldPublish ? 'yes' : 'no'}`)
          console.log(`release label: ${inferredLabel}`)

          const outputPath = process.env.GITHUB_OUTPUT
          fs.appendFileSync(outputPath, `should_publish=${shouldPublish ? 'true' : 'false'}\n`)
          fs.appendFileSync(outputPath, `release_label=${inferredLabel}\n`)
          NODE

      - name: Dispatch publish workflow
        if: ${{ steps.drift.outputs.should_publish == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'publish-npm.yml',
              ref: 'main',
              inputs: {
                release_label: '${{ steps.drift.outputs.release_label }}'
              }
            })
            core.info(`Dispatched publish-npm.yml with label: ${{ steps.drift.outputs.release_label }}`)

      - name: Skip publish dispatch
        if: ${{ steps.drift.outputs.should_publish != 'true' }}
        run: echo "No npm drift detected. Publish dispatch skipped."
